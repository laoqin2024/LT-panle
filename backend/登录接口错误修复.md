# ç™»å½•æ¥å£é”™è¯¯ä¿®å¤

## ğŸ› é—®é¢˜

ç™»å½•æ¥å£è¿”å› `500 Internal Server Error`

## ğŸ” é—®é¢˜åˆ†æ

å¯èƒ½çš„åŸå› ï¼š
1. **è§’è‰²å…³ç³»åŠ è½½é—®é¢˜** - è®¿é—® `user.role` æ—¶å…³ç³»æœªåŠ è½½
2. **å“åº”æ ¼å¼é—®é¢˜** - è¿”å›çš„å­—å…¸æ ¼å¼ä¸Pydanticæ¨¡å‹ä¸åŒ¹é…
3. **å¼‚å¸¸å¤„ç†ä¸å®Œå–„** - æŸäº›é”™è¯¯æœªè¢«æ•è·

## âœ… ä¿®å¤å†…å®¹

### 1. æ·»åŠ å…³ç³»é¢„åŠ è½½

åœ¨æŸ¥è¯¢ç”¨æˆ·æ—¶ï¼Œä½¿ç”¨ `selectinload` é¢„åŠ è½½è§’è‰²å…³ç³»ï¼š

```python
result = await db.execute(
    select(User)
    .options(selectinload(User.role))  # é¢„åŠ è½½è§’è‰²å…³ç³»
    .where(...)
)
```

### 2. æ”¹è¿›è§’è‰²åç§°è·å–

æ·»åŠ å¼‚å¸¸å¤„ç†å’Œå¤‡ç”¨æŸ¥è¯¢ï¼š

```python
role_name = None
try:
    if hasattr(user, 'role') and user.role:
        role_name = user.role.name
    else:
        # å¦‚æœå…³ç³»æœªåŠ è½½ï¼Œæ‰‹åŠ¨æŸ¥è¯¢
        role_result = await db.execute(
            select(Role).where(Role.id == user.role_id)
        )
        role = role_result.scalar_one_or_none()
        if role:
            role_name = role.name
except Exception as e:
    print(f"è·å–è§’è‰²åç§°å¤±è´¥: {e}")
    role_name = None
```

### 3. ä¿®å¤å“åº”æ ¼å¼

ç§»é™¤ `response_model` é™åˆ¶ï¼Œç›´æ¥è¿”å›å­—å…¸ï¼š

```python
@router.post("/login", summary="ç”¨æˆ·ç™»å½•")  # ç§»é™¤response_model
```

è¿”å›æ ¼å¼ï¼š
```python
return {
    "token": access_token,  # å‰ç«¯ä½¿ç”¨è¿™ä¸ªå­—æ®µ
    "access_token": access_token,
    "refresh_token": refresh_token,
    "token_type": "bearer",
    "expires_in": ACCESS_TOKEN_EXPIRE_MINUTES * 60,
    "user": user_response.dict(),
}
```

## ğŸ§ª æµ‹è¯•

### 1. æµ‹è¯•ç™»å½•é€»è¾‘

```bash
cd backend
source venv-panle/bin/activate
python æµ‹è¯•ç™»å½•æ¥å£.py
```

### 2. æµ‹è¯•APIæ¥å£

```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

## ğŸ“‹ éªŒè¯æ¸…å•

- [x] ç”¨æˆ·æŸ¥è¯¢æ­£å¸¸
- [x] å¯†ç éªŒè¯æ­£å¸¸
- [x] è§’è‰²å…³ç³»åŠ è½½æ­£å¸¸
- [x] Tokenç”Ÿæˆæ­£å¸¸
- [x] å“åº”æ ¼å¼æ­£ç¡®

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **bcryptè­¦å‘Š** - `(trapped) error reading bcrypt version` è­¦å‘Šå¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“åŠŸèƒ½
2. **å“åº”æ ¼å¼** - å‰ç«¯æœŸæœ› `token` å’Œ `user` å­—æ®µï¼Œå·²ç¡®ä¿è¿”å›è¿™äº›å­—æ®µ
3. **å…³ç³»åŠ è½½** - ä½¿ç”¨ `selectinload` ç¡®ä¿è§’è‰²å…³ç³»æ­£ç¡®åŠ è½½

## ğŸ”§ å¦‚æœè¿˜æœ‰é—®é¢˜

1. **æŸ¥çœ‹åç«¯æ—¥å¿—** - æ£€æŸ¥å…·ä½“çš„é”™è¯¯ä¿¡æ¯
2. **æ£€æŸ¥æ•°æ®åº“** - ç¡®è®¤ç”¨æˆ·å’Œè§’è‰²æ•°æ®å­˜åœ¨
3. **éªŒè¯ä¾èµ–** - ç¡®è®¤æ‰€æœ‰ä¾èµ–å·²æ­£ç¡®å®‰è£…

