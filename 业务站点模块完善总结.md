# 业务站点模块完善总结

## 一、已完成功能

### 1. 分组管理功能 ✅
- **后端API**：已实现（创建、更新、删除、列表查询）
- **前端界面**：
  - 在站点列表页面添加"管理分组"按钮
  - 分组管理对话框，支持：
    - 查看所有分组列表
    - 添加新分组
    - 编辑分组信息
    - 删除分组
    - 分组类型和描述管理
    - 排序顺序设置

### 2. 站点检查配置 ✅
- **数据模型扩展**：
  - `check_interval`: 检查间隔（秒），默认300秒（5分钟）
  - `check_timeout`: 检查超时时间（秒），默认10秒
  - `check_config`: JSON字段，存储其他检查配置（如请求头、请求方法等）
- **功能实现**：
  - 立即检查功能已使用配置的超时时间
  - 支持自定义检查配置（待前端表单完善）

### 3. 站点维护模式 ✅
- **数据模型扩展**：
  - `is_maintenance`: 是否处于维护模式
  - `maintenance_start`: 维护开始时间
  - `maintenance_end`: 维护结束时间
  - `maintenance_note`: 维护说明
- **功能实现**：
  - 立即检查时会检测维护模式
  - 维护期间跳过检查，返回维护状态
  - 支持设置维护时间范围

### 4. 站点健康度评分 ✅
- **评分规则**（总分100分）：
  - 站点状态：在线(30分)、异常(15分)、离线(0分)
  - 响应时间：<500ms(30分)、500-1000ms(20分)、1000-2000ms(10分)、>2000ms(0分)
  - 可用性：基于最近检查时间(30分)
  - SSL证书：未过期(10分)、30天内过期(5分)、已过期(0分)
- **API接口**：
  - `GET /api/sites/{site_id}/health-score` - 计算并返回健康度评分
- **前端显示**：
  - 在站点详情页状态监控标签页显示健康度评分
  - 支持手动重新计算健康度评分
  - 根据评分显示不同颜色（绿色≥80、黄色≥60、红色<60）

### 5. 批量操作功能 ✅
- 批量选择站点（复选框）
- 全选/取消全选
- 批量删除站点
- 批量启用/禁用监控

### 6. 立即检查功能 ✅
- 站点列表页面的立即检查按钮
- 站点详情页的立即检查按钮
- 自动处理SSL证书验证失败（IP地址访问）
- 使用站点配置的超时时间
- 维护模式检测

## 二、数据库变更

需要在数据库中执行SQL来添加新字段。

### 执行方式

**方式1：使用提供的执行脚本（推荐）**

```bash
# Linux/macOS
cd backend
./scripts/run_site_migration.sh

# Windows
cd backend
scripts\run_site_migration.bat
```

**方式2：使用Docker Compose**

```bash
cd backend
docker-compose exec -T postgres psql -U laoqin -d laoqin_panel < scripts/add_site_features.sql
```

**方式3：直接使用psql**

```bash
# 设置数据库连接信息（如果需要）
export DB_HOST=localhost
export DB_PORT=5432
export DB_USER=laoqin
export DB_NAME=laoqin_panel
export DB_PASSWORD=your_password

# 执行SQL文件
psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f backend/scripts/add_site_features.sql
```

**方式4：在psql中手动执行**

```bash
# 连接到数据库
psql -U laoqin -d laoqin_panel

# 在psql中执行
\i scripts/add_site_features.sql
```

### SQL内容

迁移脚本会添加以下字段：

```sql
-- 添加检查配置字段
ALTER TABLE business_sites 
ADD COLUMN IF NOT EXISTS check_interval INTEGER DEFAULT 300,
ADD COLUMN IF NOT EXISTS check_timeout INTEGER DEFAULT 10,
ADD COLUMN IF NOT EXISTS check_config JSON;

-- 添加维护模式字段
ALTER TABLE business_sites 
ADD COLUMN IF NOT EXISTS is_maintenance BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS maintenance_start TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS maintenance_end TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS maintenance_note TEXT;

-- 添加健康度评分字段
ALTER TABLE business_sites 
ADD COLUMN IF NOT EXISTS health_score INTEGER,
ADD COLUMN IF NOT EXISTS health_score_updated_at TIMESTAMP WITH TIME ZONE;
```

## 三、API接口清单

### 分组管理
- `GET /api/sites/groups` - 获取分组列表
- `POST /api/sites/groups` - 创建分组
- `PUT /api/sites/groups/{group_id}` - 更新分组
- `DELETE /api/sites/groups/{group_id}` - 删除分组

### 站点检查
- `POST /api/sites/{site_id}/check` - 立即检查站点
- `GET /api/sites/{site_id}/health-score` - 计算健康度评分

### 批量操作
- `POST /api/sites/batch/delete` - 批量删除站点
- `POST /api/sites/batch/update-monitoring` - 批量更新监控状态

## 四、待完善功能

### 1. 站点告警规则配置界面 ⏳
- 在站点详情页添加告警规则配置标签页
- 支持为站点配置自定义告警规则
- 告警规则管理（创建、编辑、删除、启用/禁用）

### 2. 站点表单扩展 ⏳
- 在站点添加/编辑表单中添加：
  - 检查配置（检查间隔、超时时间）
  - 维护模式设置（开始时间、结束时间、说明）
- 这些字段已添加到数据模型，但前端表单尚未更新

### 3. 自动监控定时任务 ⏳
- 实现定时任务，根据站点的`check_interval`自动检查站点
- 检查结果存储到TimescaleDB的`site_availability`表
- 触发告警规则检查

### 4. 健康度评分优化 ⏳
- 基于历史数据计算可用性评分（目前是简化版本）
- 支持自定义评分规则
- 健康度趋势图表

## 五、使用说明

### 分组管理
1. 在站点列表页面，点击筛选区域的"管理分组"按钮
2. 在分组管理对话框中：
   - 查看现有分组
   - 点击"编辑"按钮编辑分组
   - 点击"删除"按钮删除分组（需先移除分组下的站点）
   - 在表单中填写信息创建新分组

### 健康度评分
1. 进入站点详情页
2. 在状态监控标签页，可以看到健康度评分卡片
3. 点击刷新图标可以重新计算健康度评分
4. 评分颜色：
   - 绿色（≥80分）：健康
   - 黄色（≥60分）：一般
   - 红色（<60分）：不健康

### 维护模式
1. 目前维护模式通过API设置
2. 设置维护模式后，立即检查会返回维护状态
3. 维护期间不会触发告警

### 检查配置
1. 目前检查配置通过API设置
2. 立即检查会使用配置的超时时间
3. 检查间隔用于未来的自动监控任务

## 六、注意事项

1. **数据库迁移**：需要执行SQL添加新字段，或使用Alembic创建迁移脚本
2. **SSL证书验证**：对于IP地址访问的HTTPS站点，系统会自动跳过SSL验证
3. **维护模式**：维护期间站点检查会跳过，不会更新状态
4. **健康度评分**：评分基于当前状态和历史数据，建议定期重新计算

## 七、后续开发建议

1. **优先级高**：
   - 完善站点表单，添加检查配置和维护模式字段
   - 实现告警规则配置界面
   - 实现自动监控定时任务

2. **优先级中**：
   - 优化健康度评分算法，基于真实历史数据
   - 添加健康度趋势图表
   - 支持自定义评分规则

3. **优先级低**：
   - 分组支持多级嵌套（树形结构）
   - 站点导入/导出功能
   - 站点检查历史记录导出
