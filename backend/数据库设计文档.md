# 数据库设计文档

## 一、数据库架构

### 数据库选择
- **主数据库**: PostgreSQL 15+ with TimescaleDB
- **缓存数据库**: Redis 7+

### 数据库名称
- `laoqin_panel` - 主数据库

---

## 二、数据表设计

### 2.1 用户和认证模块

#### users（用户表）
```sql
- id: 主键
- username: 用户名（唯一）
- email: 邮箱（唯一）
- password_hash: 密码哈希
- full_name: 全名
- role_id: 角色ID（外键）
- is_active: 是否激活
- is_superuser: 是否超级用户
- last_login: 最后登录时间
- created_at: 创建时间
- updated_at: 更新时间
```

#### roles（角色表）
```sql
- id: 主键
- name: 角色名称（唯一）
- description: 描述
- created_at: 创建时间
```

#### permissions（权限表）
```sql
- id: 主键
- name: 权限名称（唯一）
- resource: 资源类型（server, device, database等）
- action: 操作类型（create, read, update, delete）
- description: 描述
- created_at: 创建时间
```

#### user_sessions（用户会话表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- token: 令牌
- ip_address: IP地址
- user_agent: 用户代理
- expires_at: 过期时间
- created_at: 创建时间
- last_activity: 最后活动时间
```

### 2.2 业务管理模块

#### business_groups（业务分组表）
```sql
- id: 主键
- name: 分组名称
- type: 分组类型
- description: 描述
- parent_id: 父分组ID（支持树形结构）
- sort_order: 排序
- created_at: 创建时间
- updated_at: 更新时间
```

#### business_sites（业务站点表）
```sql
- id: 主键
- name: 站点名称
- url: 站点URL
- type: 站点类型
- group_id: 分组ID（外键）
- description: 描述
- status: 状态（online, offline, warning）
- last_check: 最后检查时间
- last_response_time: 最后响应时间
- ssl_expiry: SSL证书过期时间
- is_monitored: 是否监控
- created_at: 创建时间
- updated_at: 更新时间
```

### 2.3 服务器管理模块

#### servers（服务器表）
```sql
- id: 主键
- name: 服务器名称
- host: 主机地址
- port: 端口
- server_type: 服务器类型（Linux, Windows）
- os_info: 操作系统信息（JSON）
- status: 状态
- network_type: 网络类型（direct, vpn, jump, tunnel）
- jump_host_id: 跳板机ID（外键）
- vpn_config: VPN配置（JSON）
- tunnel_config: 内网穿透配置（JSON）
- description: 描述
- last_check: 最后检查时间
- created_at: 创建时间
- updated_at: 更新时间
- created_by: 创建者ID（外键）
```

### 2.4 网络设备管理模块

#### network_devices（网络设备表）
```sql
- id: 主键
- name: 设备名称
- ip: IP地址
- device_type: 设备类型
- model: 设备型号
- vendor: 厂商（huawei, cisco等）
- system_version: 系统版本
- protocol: 协议（SSH, Telnet, SNMP）
- snmp_version: SNMP版本
- snmp_community: SNMP community
- network_type: 网络类型
- jump_host_id: 跳板机ID
- vpn_config: VPN配置
- tunnel_config: 内网穿透配置
- status: 状态
- description: 描述
- last_check: 最后检查时间
- created_at: 创建时间
- updated_at: 更新时间
- created_by: 创建者ID
```

#### device_interfaces（设备接口表）
```sql
- id: 主键
- device_id: 设备ID（外键）
- name: 接口名称
- interface_type: 接口类型
- status: 状态
- speed: 速率
- duplex: 双工模式
- bytes_in: 入流量（字节）
- bytes_out: 出流量（字节）
- packets_in: 入包数
- packets_out: 出包数
- errors_in: 入错误数
- errors_out: 出错误数
- last_update: 最后更新时间
```

#### device_vlans（设备VLAN表）
```sql
- id: 主键
- device_id: 设备ID（外键）
- vlan_id: VLAN ID
- name: VLAN名称
- member_count: 成员数量
- description: 描述
- last_update: 最后更新时间
```

#### device_configs（设备配置备份表）
```sql
- id: 主键
- device_id: 设备ID（外键）
- config_name: 配置文件名
- file_path: 文件路径
- config_content: 配置内容
- file_size: 文件大小
- backup_type: 备份类型（manual, auto）
- created_at: 创建时间
- created_by: 创建者ID
```

### 2.5 数据库管理模块

#### databases（数据库表）
```sql
- id: 主键
- name: 数据库名称
- type: 数据库类型（PostgreSQL, MySQL等）
- host: 主机地址
- port: 端口
- database: 数据库名
- network_type: 网络类型
- jump_host_id: 跳板机ID
- vpn_config: VPN配置
- tunnel_config: 内网穿透配置
- status: 状态
- description: 描述
- last_check: 最后检查时间
- created_at: 创建时间
- updated_at: 更新时间
- created_by: 创建者ID
```

#### database_backups（数据库备份表）
```sql
- id: 主键
- database_id: 数据库ID（外键）
- backup_name: 备份名称
- file_path: 文件路径
- file_size: 文件大小
- backup_type: 备份类型
- status: 状态
- created_at: 创建时间
- created_by: 创建者ID
```

### 2.6 应用管理模块

#### applications（应用表）
```sql
- id: 主键
- name: 应用名称
- site_id: 站点ID（外键）
- app_type: 应用类型
- config: 配置（JSON）
- status: 状态
- port: 端口
- process_name: 进程名
- description: 描述
- created_at: 创建时间
- updated_at: 更新时间
- created_by: 创建者ID
```

### 2.7 凭据管理模块

#### credentials（凭据表）
```sql
- id: 主键
- resource_type: 资源类型（server, device, database, site）
- resource_id: 资源ID
- credential_type: 凭据类型（password, ssh_key, api_key）
- username: 用户名
- password_encrypted: 加密密码
- ssh_key_path: SSH密钥路径
- description: 描述
- is_active: 是否激活
- created_at: 创建时间
- updated_at: 更新时间
- created_by: 创建者ID
```

#### credential_permissions（凭据权限表）
```sql
- id: 主键
- credential_id: 凭据ID（外键）
- user_id: 用户ID（外键）
- permission_type: 权限类型（view, use, edit, delete）
- granted_by: 授权者ID
- granted_at: 授权时间
- expires_at: 过期时间
```

#### credential_access_logs（凭据访问日志表）
```sql
- id: 主键
- credential_id: 凭据ID（外键）
- user_id: 用户ID（外键）
- action: 操作类型
- ip_address: IP地址
- user_agent: 用户代理
- accessed_at: 访问时间
- success: 是否成功
```

#### credential_history（凭据历史表）
```sql
- id: 主键
- credential_id: 凭据ID（外键）
- password_encrypted: 历史密码（加密）
- changed_at: 变更时间
- changed_by: 变更者ID
- reason: 变更原因
```

### 2.8 备份管理模块

#### backups（备份记录表）
```sql
- id: 主键
- backup_name: 备份名称
- backup_type: 备份类型（manual, daily, weekly）
- file_path: 文件路径
- file_size: 文件大小
- status: 状态
- metadata: 元数据（JSON）
- created_at: 创建时间
- created_by: 创建者ID
```

#### restores（恢复记录表）
```sql
- id: 主键
- backup_id: 备份ID（外键）
- status: 状态
- started_at: 开始时间
- completed_at: 完成时间
- error_message: 错误信息
- restored_by: 恢复者ID
```

### 2.9 系统管理模块

#### operation_logs（操作日志表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- action: 操作类型
- resource_type: 资源类型
- resource_id: 资源ID
- details: 操作详情（JSON）
- ip_address: IP地址
- user_agent: 用户代理
- created_at: 创建时间
```

#### notifications（通知表）
```sql
- id: 主键
- user_id: 用户ID（外键，null表示系统通知）
- title: 标题
- message: 消息内容
- type: 类型（info, warning, error, success）
- is_read: 是否已读
- read_at: 阅读时间
- created_at: 创建时间
```

#### settings（系统设置表）
```sql
- id: 主键
- key: 设置键（唯一）
- value: 设置值（JSON）
- description: 描述
- category: 分类（backup, notification, security等）
- updated_at: 更新时间
- updated_by: 更新者ID
```

### 2.10 时序数据表（TimescaleDB）

#### server_metrics（服务器监控指标）
```sql
- time: 时间戳（主键）
- server_id: 服务器ID
- cpu_percent: CPU使用率
- memory_used: 已用内存
- memory_total: 总内存
- memory_cached: 缓存内存
- memory_swap: Swap使用
- disk_used: 已用磁盘
- disk_total: 总磁盘
- disk_io_read: 磁盘读IO
- disk_io_write: 磁盘写IO
- network_in: 入流量
- network_out: 出流量
- load_avg_1m: 1分钟负载
- load_avg_5m: 5分钟负载
- load_avg_15m: 15分钟负载
```

#### device_metrics（设备监控指标）
```sql
- time: 时间戳
- device_id: 设备ID
- interface_name: 接口名称
- interface_status: 接口状态
- bytes_in: 入流量
- bytes_out: 出流量
- packets_in: 入包数
- packets_out: 出包数
- errors_in: 入错误数
- errors_out: 出错误数
- cpu_percent: CPU使用率
- memory_percent: 内存使用率
- temperature: 温度
```

#### site_availability（站点可用性）
```sql
- time: 时间戳
- site_id: 站点ID
- status_code: HTTP状态码
- response_time: 响应时间
- dns_time: DNS解析时间
- ssl_time: SSL握手时间
- is_available: 是否可用
- error_message: 错误信息
```

#### database_metrics（数据库监控指标）
```sql
- time: 时间戳
- database_id: 数据库ID
- connections_current: 当前连接数
- connections_max: 最大连接数
- queries_per_second: 每秒查询数
- slow_queries: 慢查询数
- cache_hit_rate: 缓存命中率
- database_size: 数据库大小
- table_count: 表数量
- lock_wait_count: 锁等待数
```

---

## 三、索引设计

### 主要索引

```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- 服务器表索引
CREATE INDEX idx_servers_host ON servers(host);
CREATE INDEX idx_servers_status ON servers(status);

-- 设备表索引
CREATE INDEX idx_devices_ip ON network_devices(ip);
CREATE INDEX idx_devices_status ON network_devices(status);
CREATE INDEX idx_devices_vendor ON network_devices(vendor);

-- 凭据表索引
CREATE INDEX idx_credentials_resource ON credentials(resource_type, resource_id);
CREATE INDEX idx_credentials_user ON credentials(created_by);

-- 操作日志索引
CREATE INDEX idx_operation_logs_user ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_created ON operation_logs(created_at);
CREATE INDEX idx_operation_logs_action ON operation_logs(action);
```

---

## 四、外键关系

### 主要外键

- `users.role_id` → `roles.id`
- `business_sites.group_id` → `business_groups.id`
- `servers.jump_host_id` → `servers.id`
- `servers.created_by` → `users.id`
- `network_devices.jump_host_id` → `servers.id`
- `network_devices.created_by` → `users.id`
- `device_interfaces.device_id` → `network_devices.id`
- `device_vlans.device_id` → `network_devices.id`
- `device_configs.device_id` → `network_devices.id`
- `databases.jump_host_id` → `servers.id`
- `databases.created_by` → `users.id`
- `database_backups.database_id` → `databases.id`
- `applications.site_id` → `business_sites.id`
- `applications.created_by` → `users.id`
- `credentials.created_by` → `users.id`
- `credential_permissions.credential_id` → `credentials.id`
- `credential_permissions.user_id` → `users.id`
- `credential_access_logs.credential_id` → `credentials.id`
- `credential_access_logs.user_id` → `users.id`
- `backups.created_by` → `users.id`
- `restores.backup_id` → `backups.id`
- `restores.restored_by` → `users.id`
- `operation_logs.user_id` → `users.id`
- `notifications.user_id` → `users.id`
- `settings.updated_by` → `users.id`

---

## 五、数据初始化

### 默认数据

1. **角色**:
   - admin（管理员）
   - user（普通用户）

2. **权限**:
   - server:create, server:read, server:update, server:delete
   - device:create, device:read, device:update, device:delete
   - database:create, database:read, database:update, database:delete
   - 等等...

3. **默认用户**:
   - username: admin
   - password: admin123
   - role: admin

---

## 六、数据库初始化步骤

### 1. 创建数据库

```bash
createdb laoqin_panel
```

### 2. 启用TimescaleDB

```sql
CREATE EXTENSION IF NOT EXISTS timescaledb;
```

### 3. 运行初始化脚本

```bash
python scripts/init_db.py
```

### 4. 创建TimescaleDB表

```bash
psql -U laoqin -d laoqin_panel -f scripts/create_timescaledb_tables.sql
```

---

## 七、数据备份策略

### 备份内容
- 所有业务表数据
- 配置文件
- 上传的文件
- 备份文件

### 备份频率
- 每日自动备份
- 每周完整备份
- 手动备份

### 备份保留
- 本地保留30天
- 远程存储（可选）

---

## 八、总结

数据库设计包含：
- ✅ 20+ 业务表
- ✅ 4个时序数据表（TimescaleDB）
- ✅ 完整的索引设计
- ✅ 外键关系
- ✅ 支持树形结构（业务分组）
- ✅ 支持网络配置（跳板机、VPN）
- ✅ 完整的权限管理
- ✅ 审计日志

数据库结构完整，支持所有前端功能需求。

