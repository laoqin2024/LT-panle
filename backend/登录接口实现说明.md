# ç™»å½•æ¥å£å®ç°è¯´æ˜

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. APIè·¯ç”±ç»“æ„
- âœ… åˆ›å»ºäº† `app/api/` ç›®å½•ç»“æ„
- âœ… å®ç°äº†è®¤è¯è·¯ç”±æ¨¡å— `auth.py`
- âœ… åˆ›å»ºäº†ä¾èµ–é¡¹æ¨¡å— `dependencies.py`
- âœ… åˆ›å»ºäº†æ•°æ®æ¨¡å‹æ¨¡å— `schemas.py`

### 2. ç™»å½•æ¥å£ (`POST /api/auth/login`)

**åŠŸèƒ½**:
- æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- å¯†ç éªŒè¯ï¼ˆbcryptï¼‰
- ç”ŸæˆJWT access_token å’Œ refresh_token
- è®°å½•ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼ˆIPã€User-Agentï¼‰
- æ›´æ–°æœ€åç™»å½•æ—¶é—´
- è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œtoken

**è¯·æ±‚æ ¼å¼**:
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**å“åº”æ ¼å¼**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "ç³»ç»Ÿç®¡ç†å‘˜",
    "role_id": 1,
    "role_name": "admin",
    "is_active": true,
    "is_superuser": true,
    "last_login": "2026-01-10T07:30:00Z",
    "created_at": "2026-01-10T07:17:59Z"
  }
}
```

### 3. åˆ·æ–°Tokenæ¥å£ (`POST /api/auth/refresh`)

**åŠŸèƒ½**:
- ä½¿ç”¨refresh_tokenè·å–æ–°çš„access_token
- éªŒè¯refresh_tokenæœ‰æ•ˆæ€§
- è¿”å›æ–°çš„access_token

**è¯·æ±‚æ ¼å¼**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 4. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ (`GET /api/auth/me`)

**åŠŸèƒ½**:
- éœ€è¦Bearer tokenè®¤è¯
- è¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <access_token>
```

### 5. ç™»å‡ºæ¥å£ (`POST /api/auth/logout`)

**åŠŸèƒ½**:
- åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯è®°å½•
- éœ€è¦Bearer tokenè®¤è¯

---

## ğŸ” è®¤è¯æœºåˆ¶

### JWT Token
- **Access Token**: 30åˆ†é’Ÿæœ‰æ•ˆæœŸï¼ˆå¯é…ç½®ï¼‰
- **Refresh Token**: 7å¤©æœ‰æ•ˆæœŸï¼ˆå¯é…ç½®ï¼‰
- **ç®—æ³•**: HS256
- **Tokenç±»å‹**: åœ¨payloadä¸­åŒ…å« `type` å­—æ®µåŒºåˆ†access/refresh

### å¯†ç åŠ å¯†
- **ç®—æ³•**: bcrypt
- **è‡ªåŠ¨åŠ ç›**: passlibè‡ªåŠ¨å¤„ç†

### è®¤è¯ä¾èµ–é¡¹
- `get_current_user`: è·å–å½“å‰ç”¨æˆ·ï¼ˆUserå¯¹è±¡ï¼‰
- `get_current_active_user`: è·å–æ¿€æ´»ç”¨æˆ·
- `get_current_superuser`: è·å–è¶…çº§ç”¨æˆ·
- `get_current_user_response`: è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå“åº”æ ¼å¼ï¼‰

---

## ğŸ“ APIç«¯ç‚¹åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | éœ€è¦è®¤è¯ |
|------|------|------|---------|
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• | âŒ |
| POST | `/api/auth/refresh` | åˆ·æ–°Token | âŒ |
| GET | `/api/auth/me` | è·å–å½“å‰ç”¨æˆ· | âœ… |
| POST | `/api/auth/logout` | ç”¨æˆ·ç™»å‡º | âœ… |

---

## ğŸš€ æµ‹è¯•æ–¹æ³•

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
source venv-panle/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. è®¿é—®APIæ–‡æ¡£

- **Swagger UI**: http://localhost:8000/api/docs
- **ReDoc**: http://localhost:8000/api/redoc

### 3. ä½¿ç”¨curlæµ‹è¯•ç™»å½•

```bash
# ç™»å½•
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'

# è·å–å½“å‰ç”¨æˆ·ï¼ˆéœ€è¦tokenï¼‰
curl -X GET "http://localhost:8000/api/auth/me" \
  -H "Authorization: Bearer <your_access_token>"
```

### 4. ä½¿ç”¨Pythonæµ‹è¯•

```python
import requests

# ç™»å½•
response = requests.post(
    "http://localhost:8000/api/auth/login",
    json={
        "username": "admin",
        "password": "admin123"
    }
)

data = response.json()
token = data["access_token"]
user = data["user"]

print(f"ç™»å½•æˆåŠŸï¼ç”¨æˆ·: {user['username']}")
print(f"Token: {token[:50]}...")

# è·å–å½“å‰ç”¨æˆ·
headers = {"Authorization": f"Bearer {token}"}
me_response = requests.get(
    "http://localhost:8000/api/auth/me",
    headers=headers
)
print(me_response.json())
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### Tokenè¿‡æœŸæ—¶é—´

åœ¨ `app/core/config.py` ä¸­é…ç½®ï¼š

```python
ACCESS_TOKEN_EXPIRE_MINUTES: int = 30  # Access Token 30åˆ†é’Ÿ
REFRESH_TOKEN_EXPIRE_DAYS: int = 7     # Refresh Token 7å¤©
```

### å¯†é’¥é…ç½®

**âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼**

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```env
SECRET_KEY=your-very-secret-key-change-in-production
ALGORITHM=HS256
```

---

## ğŸ“‹ å‰ç«¯é›†æˆ

å‰ç«¯å·²ç»é…ç½®å¥½ï¼Œåªéœ€è¦ï¼š

1. **ç™»å½•è¯·æ±‚**: `POST /api/auth/login`
2. **ä¿å­˜Token**: å­˜å‚¨ `access_token` åˆ° localStorage
3. **è¯·æ±‚å¤´**: æ‰€æœ‰APIè¯·æ±‚è‡ªåŠ¨æ·»åŠ  `Authorization: Bearer <token>`
4. **Tokenåˆ·æ–°**: å½“tokenè¿‡æœŸæ—¶ï¼Œä½¿ç”¨ `refresh_token` åˆ·æ–°

å‰ç«¯ä»£ç å·²å®ç°ï¼ˆ`frontend/src/pages/Login.tsx` å’Œ `frontend/src/services/api.ts`ï¼‰ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é»˜è®¤å¯†ç **: é»˜è®¤ç®¡ç†å‘˜å¯†ç æ˜¯ `admin123`ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹
2. **å¯†é’¥å®‰å…¨**: `SECRET_KEY` å¿…é¡»ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
3. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
4. **Tokenå­˜å‚¨**: å‰ç«¯åº”ä½¿ç”¨httpOnly cookieå­˜å‚¨tokenï¼ˆæ›´å®‰å…¨ï¼‰
5. **ä¼šè¯ç®¡ç†**: å½“å‰å®ç°ä¼šè®°å½•æ‰€æœ‰ä¼šè¯ï¼Œç”Ÿäº§ç¯å¢ƒå¯è€ƒè™‘é™åˆ¶ä¼šè¯æ•°é‡

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç™»å½•è¿”å›401é”™è¯¯
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨ï¼ˆ`is_active=False`ï¼‰

### Q2: TokenéªŒè¯å¤±è´¥
- æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
- æ£€æŸ¥tokenæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆBearer <token>ï¼‰
- æ£€æŸ¥SECRET_KEYæ˜¯å¦ä¸€è‡´

### Q3: æ— æ³•è·å–å½“å‰ç”¨æˆ·
- æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `Authorization: Bearer <token>`
- æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… ç™»å½•æ¥å£
- âœ… Tokenåˆ·æ–°æ¥å£
- âœ… è·å–å½“å‰ç”¨æˆ·æ¥å£
- âœ… ç™»å‡ºæ¥å£
- âœ… è®¤è¯ä¾èµ–é¡¹
- âœ… é”™è¯¯å¤„ç†
- âœ… APIæ–‡æ¡£ï¼ˆSwagger/ReDocï¼‰

**ç™»å½•æ¥å£å·²å®Œå…¨å®ç°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼**

