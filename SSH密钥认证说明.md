# SSH密钥认证说明

## 一、SSH密钥认证原理

### 1.1 密钥对组成

SSH密钥认证使用**非对称加密**，包含两个部分：

- **私钥（Private Key）**：保存在客户端，**必须保密**，用于身份验证
- **公钥（Public Key）**：保存在服务器上（`~/.ssh/authorized_keys`），可以公开

### 1.2 认证流程

```
客户端（本系统）                   服务器（远程主机）
    |                                    |
    |  1. 使用私钥签名挑战              |
    |---------------------------------->|
    |                                    |
    |  2. 服务器验证签名（使用公钥）     |
    |<----------------------------------|
    |                                    |
    |  3. 认证成功，建立连接             |
    |====================================|
```

## 二、应该使用私钥还是公钥？

### ✅ **答案：使用私钥**

**原因：**

1. **客户端认证**：本系统作为SSH客户端，需要私钥来证明身份
2. **私钥的作用**：私钥用于签名和身份验证，只有拥有私钥才能登录
3. **公钥的作用**：公钥已经放在服务器上，不需要在客户端存储

### ❌ **错误理解：**

- ❌ 使用公钥进行登录（公钥无法用于客户端认证）
- ❌ 在客户端存储公钥（公钥应该在服务器上）

## 三、正确的使用方式

### 3.1 密钥生成（在客户端）

```bash
# 生成SSH密钥对（4096位RSA）
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 生成的文件：
# ~/.ssh/id_rsa      ← 私钥（保密，用于登录）
# ~/.ssh/id_rsa.pub  ← 公钥（可以公开，需要复制到服务器）
```

### 3.2 公钥部署（在服务器上）

```bash
# 方法1：使用ssh-copy-id（推荐）
ssh-copy-id -i ~/.ssh/id_rsa.pub user@server

# 方法2：手动复制
cat ~/.ssh/id_rsa.pub | ssh user@server "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

# 方法3：手动编辑
# 在服务器上编辑 ~/.ssh/authorized_keys，添加公钥内容
```

### 3.3 在本系统中使用

**应该存储：**
- ✅ **私钥路径**：`~/.ssh/id_rsa` 或 `/path/to/private/key`
- ✅ **私钥内容**：如果需要，可以存储私钥内容（加密存储）

**不应该存储：**
- ❌ 公钥路径（公钥在服务器上）
- ❌ 公钥内容（不需要）

## 四、安全注意事项

### 4.1 私钥安全

1. **权限设置**：
   ```bash
   chmod 600 ~/.ssh/id_rsa  # 私钥只能所有者读写
   chmod 644 ~/.ssh/id_rsa.pub  # 公钥可以公开
   ```

2. **私钥保护**：
   - 私钥**绝对不能**泄露
   - 不要将私钥提交到代码仓库
   - 使用密码保护私钥（passphrase）
   - 定期轮换密钥

3. **存储方式**：
   - 本系统应该**加密存储**私钥内容
   - 或者只存储私钥路径（如果私钥在安全的服务器上）

### 4.2 公钥安全

1. **公钥可以公开**，但也要防止被替换
2. **服务器上的authorized_keys**应该设置正确的权限：
   ```bash
   chmod 600 ~/.ssh/authorized_keys
   chmod 700 ~/.ssh
   ```

## 五、本系统实现建议

### 5.1 存储方式

**方案1：存储私钥路径（推荐）**
- 优点：私钥不离开原始位置，更安全
- 缺点：需要确保后端服务器可以访问该路径

**方案2：存储私钥内容（加密）**
- 优点：不依赖文件系统路径，更灵活
- 缺点：需要确保加密存储的安全性

### 5.2 当前实现

当前代码中：
- `ssh_key_path`：存储私钥路径 ✅
- `password_encrypted`：可以存储私钥内容（加密）✅

**建议：**
1. 优先使用**私钥路径**方式
2. 如果路径不可用，再考虑存储私钥内容（加密）
3. 前端提示应该明确说明使用**私钥路径**

## 六、常见问题

### Q1: 为什么不能使用公钥登录？

**A:** 公钥只能用于验证，不能用于签名。SSH认证需要客户端使用私钥签名，服务器使用公钥验证。

### Q2: 私钥和公钥可以互换吗？

**A:** 不可以。私钥和公钥是配对的，不能互换使用。

### Q3: 一个私钥可以对应多个服务器吗？

**A:** 可以。只要将对应的公钥添加到每个服务器的`authorized_keys`文件中即可。

### Q4: 如何查看私钥和公钥？

```bash
# 查看私钥（注意：不要泄露）
cat ~/.ssh/id_rsa

# 查看公钥（可以安全查看）
cat ~/.ssh/id_rsa.pub
```

### Q5: 私钥丢失怎么办？

**A:** 如果私钥丢失且没有备份，需要：
1. 生成新的密钥对
2. 将新公钥添加到服务器
3. 删除旧公钥（如果可能）

## 七、总结

- ✅ **使用私钥**进行SSH远程登录
- ✅ **私钥路径**：`~/.ssh/id_rsa` 或自定义路径
- ✅ **私钥必须保密**，加密存储
- ✅ **公钥在服务器上**，不需要在客户端存储
- ✅ **前端提示应该明确说明使用私钥路径**
