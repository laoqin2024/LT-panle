# 依赖安装问题解决方案

## 问题1: psycopg2-binary 安装失败

### 错误信息
```
Error: pg_config executable not found.
```

### 解决方案
已更新 `requirements.txt`，使用 `psycopg2-binary>=2.9.9` 而不是固定版本，这样可以自动选择兼容的预编译版本。

---

## 问题2: telnetlib3 安装失败

### 错误信息
```
ERROR: Failed to build 'telnetlib3' when getting requirements to build wheel
ModuleNotFoundError: No module named 'pip'
```

### 原因
- `telnetlib3==0.2.0` 版本太旧（2016年发布）
- 不兼容 Python 3.14
- 构建系统有问题

### 解决方案

#### 方案1: 移除 telnetlib3（推荐）

`telnetlib3` 主要用于异步 Telnet 连接，但：
- 项目主要使用 SSH（paramiko/netmiko）
- Telnet 可以通过其他方式实现
- 该包已不再维护

**已从 requirements.txt 中移除**

#### 方案2: 如果需要 Telnet 功能

可以使用以下替代方案：

1. **使用同步 telnetlib**（Python 标准库）
```python
import telnetlib

tn = telnetlib.Telnet(host, port)
tn.read_until(b"login: ")
tn.write(username.encode('ascii') + b"\n")
```

2. **使用 asyncio + socket**
```python
import asyncio

async def telnet_connect(host, port):
    reader, writer = await asyncio.open_connection(host, port)
    # 处理 Telnet 协议
    return reader, writer
```

3. **使用 netmiko**（已包含）
```python
from netmiko import ConnectHandler

device = {
    'device_type': 'cisco_ios_telnet',
    'host': host,
    'port': port,
    'username': username,
    'password': password,
}
conn = ConnectHandler(**device)
```

---

## 更新后的依赖

已更新 `requirements.txt`：
- ✅ 使用 `>=` 而不是 `==`，允许安装兼容的更新版本
- ✅ 移除了 `telnetlib3`（已废弃）
- ✅ 保留了所有其他必需的依赖

---

## 重新安装步骤

### 1. 删除旧的虚拟环境（如果存在）

```bash
cd backend
rm -rf venv-panle  # Linux/macOS
# 或
rmdir /s venv-panle  # Windows
```

### 2. 重新创建虚拟环境

```bash
# Linux/macOS
bash setup_venv.sh

# Windows
setup_venv.bat
```

### 3. 如果仍有问题，手动安装

```bash
# 激活虚拟环境
source venv-panle/bin/activate  # Linux/macOS
# 或
venv-panle\Scripts\activate.bat  # Windows

# 升级 pip 和 setuptools
pip install --upgrade pip setuptools wheel

# 安装依赖
pip install -r requirements.txt
```

---

## 如果还有问题

### 检查 Python 版本

```bash
python3 --version
# 应该显示 Python 3.8 到 3.13
# Python 3.14 可能太新，某些包可能不兼容
```

### 使用 Python 3.13 或更低版本（推荐）

如果使用 Python 3.14，建议降级到 Python 3.13 或 3.12：

```bash
# 使用 pyenv 管理 Python 版本
pyenv install 3.12.0
pyenv local 3.12.0

# 然后重新创建虚拟环境
python3 -m venv venv-panle
source venv-panle/bin/activate
pip install -r requirements.txt
```

### 分步安装依赖

如果批量安装失败，可以分步安装：

```bash
# 1. 先安装基础依赖
pip install fastapi uvicorn sqlalchemy

# 2. 安装数据库相关
pip install asyncpg psycopg2-binary alembic

# 3. 安装其他依赖
pip install -r requirements.txt
```

---

## 验证安装

安装完成后，验证关键包：

```bash
# 激活虚拟环境后
source venv-panle/bin/activate  # Linux/macOS
# 或
venv-panle\Scripts\activate.bat  # Windows

# 然后验证（注意：使用 python 而不是 python3，因为虚拟环境已激活）
python -c "import fastapi; print('FastAPI:', fastapi.__version__)"
python -c "import sqlalchemy; print('SQLAlchemy:', sqlalchemy.__version__)"
python -c "import asyncpg; print('asyncpg:', asyncpg.__version__)"
python -c "import psycopg2; print('psycopg2:', psycopg2.__version__)"
```

### 如果使用 pyenv

如果你使用 pyenv 管理 Python 版本，注意：

1. **创建虚拟环境时使用 `python3`**:
   ```bash
   python3 -m venv venv-panle
   ```

2. **激活虚拟环境后使用 `python`**:
   ```bash
   source venv-panle/bin/activate
   python --version  # 应该显示虚拟环境中的 Python 版本
   ```

3. **如果 `python` 命令不存在**:
   ```bash
   # 在虚拟环境中，python 和 python3 应该都可用
   # 如果不行，可以创建符号链接
   cd venv-panle/bin
   ln -s python3 python
   ```

---

## 总结

主要问题：
1. ✅ `psycopg2-binary` - 已更新为使用 `>=` 版本
2. ✅ `telnetlib3` - 已移除（已废弃，不兼容新版本 Python）

如果使用 Python 3.14，建议：
- 降级到 Python 3.12 或 3.13（更稳定）
- 或者等待包更新支持 Python 3.14

