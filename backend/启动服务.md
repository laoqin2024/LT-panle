# 后端服务启动指南

## 错误：端口已被占用

### 错误信息
```
ERROR: [Errno 48] Address already in use
```

### 原因
端口 8000 已被其他进程占用。

---

## 解决方案

### 方案1: 查找并停止占用端口的进程（推荐）

#### 查找占用端口的进程
```bash
# macOS/Linux
lsof -i :8000

# 或使用
netstat -an | grep 8000
```

#### 停止进程
```bash
# 找到进程ID（PID）后
kill -9 <PID>

# 或直接停止
killall -9 uvicorn
```

### 方案2: 使用其他端口

```bash
# 使用8001端口
uvicorn app.main:app --reload --host 0.0.0.0 --port 8001

# 或使用8080端口
uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
```

### 方案3: 修改配置文件

编辑 `.env` 文件，添加：
```env
PORT=8001
```

然后修改启动命令或代码。

---

## 正确的启动步骤

### 1. 进入项目目录

```bash
cd "/Volumes/MyDisk/App programs/laoqin-panle/backend"
```

### 2. 激活虚拟环境

```bash
source venv-panle/bin/activate
```

### 3. 检查端口占用

```bash
lsof -i :8000
```

### 4. 启动服务

```bash
# 如果8000端口可用
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 如果8000端口被占用，使用其他端口
uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
```

---

## 验证服务运行

### 检查服务状态

```bash
# 检查进程
ps aux | grep uvicorn

# 检查端口
lsof -i :8000  # 或你使用的端口
```

### 测试API

```bash
# 健康检查
curl http://localhost:8000/api/health

# 或访问API文档
open http://localhost:8000/api/docs
```

---

## 常见问题

### Q1: 如何后台运行？

```bash
# 使用 nohup
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &

# 或使用 screen/tmux
screen -S laoqin-api
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
# 按 Ctrl+A 然后 D 退出screen
```

### Q2: 如何查看日志？

```bash
# 如果使用 nohup
tail -f app.log

# 如果在前台运行，日志会直接输出
```

### Q3: 如何停止服务？

```bash
# 查找进程
ps aux | grep uvicorn

# 停止进程
kill <PID>

# 或
pkill -f uvicorn
```

---

## 生产环境启动

### 使用 Gunicorn（推荐）

```bash
# 安装 gunicorn
pip install gunicorn

# 启动（4个工作进程）
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 使用 systemd（Linux）

创建服务文件 `/etc/systemd/system/laoqin-api.service`:

```ini
[Unit]
Description=Laoqin Panel API
After=network.target

[Service]
User=your-user
WorkingDirectory=/path/to/backend
Environment="PATH=/path/to/venv-panle/bin"
ExecStart=/path/to/venv-panle/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000

[Install]
WantedBy=multi-user.target
```

然后：
```bash
sudo systemctl start laoqin-api
sudo systemctl enable laoqin-api
```

---

## 快速启动脚本

我创建了一个启动脚本，可以自动处理端口占用问题。

```bash
bash scripts/start_server.sh
```

