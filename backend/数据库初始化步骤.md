# 数据库初始化步骤

## 当前状态

✅ PostgreSQL 容器已运行（laoqin_postgres）
✅ Redis 容器已运行（laoqin_redis）

## 初始化步骤

### 步骤1: 检查数据库连接

```bash
cd backend

# 测试 PostgreSQL 连接
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "SELECT version();"
```

如果连接成功，会显示 PostgreSQL 版本信息。

### 步骤2: 启用 TimescaleDB 扩展

```bash
# 连接到数据库并启用 TimescaleDB
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "CREATE EXTENSION IF NOT EXISTS timescaledb;"
```

### 步骤3: 创建 TimescaleDB 时序表

```bash
# 执行 TimescaleDB 表创建脚本
docker-compose exec -T postgres psql -U laoqin -d laoqin_panel < scripts/create_timescaledb_tables.sql
```

或者手动执行：

```bash
docker-compose exec postgres psql -U laoqin -d laoqin_panel
```

然后在 psql 中执行：
```sql
\i /docker-entrypoint-initdb.d/init-timescale.sql
```

### 步骤4: 初始化业务数据表

```bash
# 激活虚拟环境
source venv-panle/bin/activate

# 运行初始化脚本
python scripts/init_db.py
```

这个脚本会：
- 创建所有业务表（users, roles, permissions, servers, devices 等）
- 创建默认角色（admin, user）
- 创建默认权限
- 创建默认管理员用户（admin/admin123）

### 步骤5: 验证初始化结果

```bash
# 检查表是否创建
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "\dt"

# 检查用户是否创建
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "SELECT username, email, is_active FROM users;"

# 检查角色是否创建
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "SELECT name, description FROM roles;"

# 检查 TimescaleDB 表
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "SELECT * FROM timescaledb_information.hypertables;"
```

---

## 一键初始化脚本

我创建了一个自动化脚本，可以一键完成所有初始化步骤。

```bash
cd backend
bash scripts/init_database.sh
```

---

## 常见问题

### Q1: 连接数据库失败

**错误**: `psql: error: connection to server at "localhost" (127.0.0.1), port 5432 failed`

**解决**:
```bash
# 确保容器正在运行
docker-compose ps

# 检查容器日志
docker-compose logs postgres
```

### Q2: TimescaleDB 扩展创建失败

**错误**: `ERROR: extension "timescaledb" is not available`

**解决**:
```bash
# 检查 TimescaleDB 是否已安装
docker-compose exec postgres psql -U laoqin -d laoqin_panel -c "SELECT * FROM pg_available_extensions WHERE name = 'timescaledb';"

# 如果未安装，可能需要重新拉取镜像
docker-compose down
docker-compose pull
docker-compose up -d
```

### Q3: 权限错误

**错误**: `permission denied`

**解决**:
```bash
# 确保使用正确的用户
docker-compose exec postgres psql -U laoqin -d laoqin_panel

# 或者使用 postgres 超级用户
docker-compose exec postgres psql -U postgres -d laoqin_panel
```

---

## 初始化后的默认数据

### 默认管理员账号
- **用户名**: `admin`
- **密码**: `admin123`
- **角色**: `admin`
- ⚠️ **首次登录后请立即修改密码！**

### 默认角色
- `admin` - 管理员
- `user` - 普通用户

### 默认权限
- server:create, server:read, server:update, server:delete
- device:create, device:read, device:update, device:delete
- database:create, database:read, database:update, database:delete
- 等等...

---

## 下一步

初始化完成后，可以：

1. **启动后端服务**
   ```bash
   cd backend
   source venv-panle/bin/activate
   uvicorn app.main:app --reload
   ```

2. **访问 API 文档**
   - Swagger UI: http://localhost:8000/api/docs
   - ReDoc: http://localhost:8000/api/redoc

3. **测试登录**
   - 使用默认账号 admin/admin123 登录

---

## 数据备份

初始化完成后，建议立即备份：

```bash
# 备份数据库
docker-compose exec postgres pg_dump -U laoqin laoqin_panel > backup_initial.sql

# 恢复数据库（如果需要）
docker-compose exec -T postgres psql -U laoqin -d laoqin_panel < backup_initial.sql
```

