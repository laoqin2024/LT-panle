# 服务器默认凭据功能说明

## 功能概述

为每个服务器设置默认凭据，在使用SSH终端、文件管理、进程管理等功能时自动选择关联的凭据，避免频繁手动选择。

## 实现内容

### 1. 数据库层面

#### 模型更新
- **文件**: `backend/app/models/server.py`
- **新增字段**: `default_credential_id` - 外键关联到 `credentials` 表
- **关系**: 添加 `default_credential` 关系，可直接访问默认凭据对象

#### 数据库迁移
- 自动生成迁移文件: `19e51cd559f6_add_default_credential_id_to_servers.py`
- 已执行迁移，`servers` 表新增 `default_credential_id` 字段
- 字段可为空，允许服务器不设置默认凭据

### 2. 后端API层面

#### Schema更新
- **文件**: `backend/app/api/schemas.py`
- **ServerBase**: 添加 `default_credential_id` 字段
- **ServerCreate**: 支持创建时设置默认凭据
- **ServerUpdate**: 支持更新默认凭据
- **ServerResponse**: 返回 `default_credential` 对象（包含凭据详细信息）

#### API更新
- **文件**: `backend/app/api/servers.py`
- **查询优化**: 所有服务器查询都使用 `selectinload(Server.default_credential)` 预加载凭据信息
- **验证逻辑**: 创建/更新服务器时验证指定的凭据是否存在
- **关联数据**: API响应中包含完整的默认凭据信息

### 3. 前端实现

#### 类型定义更新
- **文件**: `frontend/src/services/servers.ts`
- **Server接口**: 添加 `default_credential_id` 和 `default_credential` 字段
- **ServerCreate/Update**: 支持默认凭据字段

#### 服务器表单
- **文件**: `frontend/src/pages/Servers.tsx`
- **新增功能**:
  - 表单中添加"默认凭据"选择器
  - 下拉列表显示所有可用凭据（用户名、描述、类型）
  - 提示说明：设置后会在各功能中自动选择
  - 支持"不设置默认凭据"选项

#### 自动选择凭据
- **文件**: `frontend/src/pages/ServerDetail.tsx`
- **实现逻辑**:
  - 加载服务器详情时，检查是否有 `default_credential_id`
  - 如果有且当前未选择凭据，自动选择默认凭据
  - 用户仍可手动切换到其他凭据

## 使用场景

### 场景1：新建服务器时设置默认凭据

1. 点击"添加服务器"按钮
2. 填写服务器基本信息（名称、地址、端口等）
3. 在"默认凭据"下拉框中选择常用的凭据
4. 保存后，该服务器的所有操作都会优先使用此凭据

### 场景2：为现有服务器设置默认凭据

1. 在服务器列表中点击"编辑"按钮
2. 在编辑表单中选择"默认凭据"
3. 保存后生效

### 场景3：使用默认凭据

1. 进入服务器详情页
2. 切换到"SSH终端"、"文件管理"、"进程管理"等标签
3. 凭据选择器会自动选中默认凭据
4. 无需手动选择，直接使用功能

### 场景4：临时使用其他凭据

1. 即使设置了默认凭据，仍可在凭据选择器中切换
2. 切换后的凭据仅在当前会话有效
3. 刷新页面后会重新使用默认凭据

## 优势

### 1. 提升效率
- 减少重复操作，避免每次都要手动选择凭据
- 特别适合频繁操作的服务器

### 2. 降低错误
- 避免选错凭据导致连接失败
- 每个服务器关联固定凭据，减少混淆

### 3. 灵活性
- 默认凭据是可选的，不强制设置
- 可随时修改默认凭据
- 仍支持临时切换到其他凭据

### 4. 用户体验
- 自动选择，无感知
- 减少点击次数
- 操作更流畅

## 数据流程

```
创建/编辑服务器
    ↓
选择默认凭据（可选）
    ↓
保存到数据库（default_credential_id）
    ↓
进入服务器详情页
    ↓
加载服务器信息（包含default_credential）
    ↓
自动选择默认凭据
    ↓
使用SSH终端/文件管理等功能
    ↓
无需手动选择凭据
```

## 注意事项

### 1. 凭据删除
- 如果删除了某个凭据，使用该凭据作为默认凭据的服务器会自动清空 `default_credential_id`
- 数据库外键约束设置为 `ON DELETE SET NULL`

### 2. 凭据权限
- 默认凭据的选择不受权限限制
- 但实际使用时仍需检查用户是否有权限使用该凭据

### 3. 多用户环境
- 默认凭据是服务器级别的设置，对所有用户生效
- 如需用户级别的默认凭据，需要额外开发

### 4. 兼容性
- 未设置默认凭据的服务器仍按原有方式工作
- 不影响现有功能

## 后续优化建议

### 1. 用户级别默认凭据
- 允许每个用户为同一服务器设置不同的默认凭据
- 优先级：用户级 > 服务器级

### 2. 凭据组
- 支持为服务器关联多个凭据
- 按优先级自动尝试连接

### 3. 智能推荐
- 根据历史使用记录推荐默认凭据
- 自动检测最常用的凭据

### 4. 批量设置
- 支持批量为多个服务器设置默认凭据
- 按服务器类型、标签等批量配置

## 技术细节

### 数据库外键
```sql
ALTER TABLE servers 
ADD COLUMN default_credential_id INTEGER 
REFERENCES credentials(id) ON DELETE SET NULL;
```

### 后端查询优化
```python
query = select(Server).options(
    selectinload(Server.jump_host),
    selectinload(Server.default_credential)
)
```

### 前端自动选择
```typescript
const loadServer = async () => {
  const data = await getServer(parseInt(id || '0'))
  setServer(data)
  
  // 自动选择默认凭据
  if (data.default_credential_id && !selectedCredential) {
    setSelectedCredential(data.default_credential_id)
  }
}
```

## 总结

服务器默认凭据功能通过在服务器和凭据之间建立关联，实现了自动选择凭据的能力，大大提升了用户体验和操作效率。该功能设计灵活，既支持自动化，又保留了手动控制的能力，是一个实用的增强功能。
