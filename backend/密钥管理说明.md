# 密钥管理说明

## 📋 功能概述

系统在初始化部署时会自动生成安全的密钥，并保存到 `.env` 配置文件中，无需手动填写。

## 🔐 自动生成的密钥

1. **SECRET_KEY** - JWT签名密钥（512位）
   - 用于JWT token的签名和验证
   - 长度：128个十六进制字符（64字节）

2. **ENCRYPTION_KEY** - AES加密密钥（256位）
   - 用于加密敏感数据（如密码、凭证等）
   - 长度：44个Base64字符（32字节）

## 🚀 使用方法

### 方法1: 自动生成（推荐）

在数据库初始化时，密钥会自动生成：

```bash
cd backend
source venv-panle/bin/activate
python scripts/init_db.py
```

### 方法2: 单独生成密钥

如果需要单独生成或重新生成密钥：

```bash
cd backend
source venv-panle/bin/activate

# 生成密钥（如果已存在则使用现有的）
python scripts/init_keys.py

# 强制重新生成所有密钥
python scripts/init_keys.py --force
# 或
python scripts/init_keys.py -f
```

### 方法3: 直接使用密钥生成工具

```bash
cd backend
source venv-panle/bin/activate
python -m app.core.key_generator
```

## 📁 配置文件位置

密钥保存在项目根目录（backend目录）下的 `.env` 文件中：

```
backend/
├── .env              # 密钥配置文件（自动生成）
├── .env.example      # 配置文件示例
└── ...
```

## 🔒 安全注意事项

### 1. 文件权限

生产环境部署时，请设置正确的文件权限：

```bash
chmod 600 .env
```

### 2. 版本控制

**⚠️ 重要：不要将 `.env` 文件提交到版本控制系统！**

确保 `.gitignore` 包含：

```
.env
.env.local
.env.*.local
```

### 3. 密钥泄露处理

如果密钥泄露，请立即：

1. 重新生成密钥：
   ```bash
   python scripts/init_keys.py --force
   ```

2. 更新所有使用该密钥的服务

3. 使所有现有的JWT token失效（用户需要重新登录）

4. 重新加密所有使用旧密钥加密的数据

## 📝 密钥生成规则

### SECRET_KEY

- **算法**: 使用 `secrets.token_hex()` 生成加密安全的随机字节
- **长度**: 64字节（512位）
- **格式**: 十六进制字符串（128个字符）
- **示例**: `a1b2c3d4e5f6...` (128字符)

### ENCRYPTION_KEY

- **算法**: 使用 `secrets.token_bytes()` 生成加密安全的随机字节
- **长度**: 32字节（256位）
- **格式**: Base64编码字符串（44个字符）
- **示例**: `YWJjZGVmZ2hpams...` (44字符)

## 🔄 密钥更新流程

### 开发环境

直接重新生成即可：

```bash
python scripts/init_keys.py --force
```

### 生产环境

1. **备份现有密钥**（如果需要解密旧数据）
   ```bash
   cp .env .env.backup
   ```

2. **重新生成密钥**
   ```bash
   python scripts/init_keys.py --force
   ```

3. **重启服务**
   ```bash
   # 重启后端服务
   systemctl restart laoqin-api
   ```

4. **通知用户重新登录**（因为JWT token会失效）

## 🛠️ 技术实现

### 密钥生成模块

位置：`app/core/key_generator.py`

主要函数：
- `generate_secret_key()` - 生成JWT密钥
- `generate_encryption_key()` - 生成AES密钥
- `generate_and_save_keys()` - 生成并保存到.env文件

### 初始化集成

在 `scripts/init_db.py` 中，数据库初始化前会自动检查并生成密钥。

## ✅ 验证密钥

### 检查密钥是否已生成

```bash
# 查看.env文件中的密钥
grep -E "SECRET_KEY|ENCRYPTION_KEY" .env
```

### 验证密钥格式

```python
from app.core.key_generator import read_env_value
from pathlib import Path

env_path = Path(".env")
secret_key = read_env_value(env_path, "SECRET_KEY")
encryption_key = read_env_value(env_path, "ENCRYPTION_KEY")

print(f"SECRET_KEY 长度: {len(secret_key) if secret_key else 0}")
print(f"ENCRYPTION_KEY 长度: {len(encryption_key) if encryption_key else 0}")
```

## 📚 相关文件

- `app/core/key_generator.py` - 密钥生成工具
- `app/core/config.py` - 配置管理（从.env读取）
- `scripts/init_keys.py` - 密钥初始化脚本
- `scripts/init_db.py` - 数据库初始化（包含密钥生成）
- `.env.example` - 配置文件示例

## 🎯 最佳实践

1. **首次部署**: 运行 `init_db.py`，密钥会自动生成
2. **密钥轮换**: 定期（如每季度）重新生成密钥
3. **备份管理**: 生产环境密钥应备份到安全位置
4. **权限控制**: 只有必要的用户才能访问 `.env` 文件
5. **监控告警**: 监控密钥使用情况，异常时及时告警

---

**总结**: 系统会自动处理密钥生成，你只需要在首次部署时运行初始化脚本即可。无需手动填写或生成密钥！

